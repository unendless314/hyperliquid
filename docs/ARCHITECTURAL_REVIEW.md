# 系統架構審查與優化建議 (Architectural Review)

**日期**: 2026-01-14
**狀態**: 待定 (保留供未來開發參考與檢討)
**背景**: 本文件基於 PRD v1.2 與 System Design v1.2 進行審查，旨在分析潛在的過度設計 (Over-Engineering) 風險，並提出簡化建議。適用於個人或小規模跟單系統。

---

## 1. 潛在的冗餘功能分析 (Potential Redundancies)

經分析，以下功能在生產級別的機構系統中雖有必要，但對於個人跟單專案可能顯得過於複雜且非絕對必要：

### 1.1 自動訊號回補 (Complex Gap Backfilling)
*   **原設計**: 斷線重連時，若區塊高度落差在 `BACKFILL_WINDOW` 內，透過 REST API 抓取歷史訊號並補單。
*   **風險/冗餘**: 跟單講究時效，過期訊號往往導致進場價格極差。實作歷史回放邏輯（處理開倉、平倉順序）極易產生 Bug。

### 1.2 自動對帳修復 (Auto-Resolve in Reconciliation)
*   **原設計**: `Reconciler` 發現倉位偏差時，嘗試自動下單進行多退少補或平倉。
*   **風險/冗餘**: 錯誤的自動修復邏輯可能導致連鎖停損或無限開倉。
*   **建議**: 僅保留「偵測與警報 (Alerting)」，由人工介入處理更為安全。

### 1.3 凱利公式倉位管理 (Kelly Criterion)
*   **原設計**: 支援凱利公式計算下單金額。
*   **風險/冗餘**: 難以即時獲得準確的勝率/賠率期望值。建議保留「固定金額」或「固定比例」即可。

### 1.4 嚴格的配置審計 (Strict Config Auditing)
*   **原設計**: 將 Config Hash 寫入 DB 並在 Runtime 強制比對。
*   **風險/冗餘**: Git 版本控制已足夠應對個人需求。

### 1.5 完整訂單狀態機 (Full Order FSM)
*   **原設計**: 追蹤 `PENDING` -> `SUBMITTED` -> `PARTIALLY_FILLED` 等細微狀態。
*   **風險/冗餘**: 市價單 (Market Order) 通常瞬間成交或失敗，不需要過於複雜的狀態流轉。

---

## 2. 關於「自動回補」與「風控機制」的進一步探討

**問題**: 系統已規劃價格滑點 (Slippage) 與保證金檢測，即便回補了過期訊號，理論上也會被風控擋下，風險是否沒那麼大？

**分析**:
是的，**風控層 (Risk Control Layer)** 確實是最後一道防線。若回補的訊號價格偏離過大，`Strategy` 層理應拒絕下單。

然而，保留「自動回補」仍有以下隱患：
1.  **邏輯複雜度 (Complexity)**: 需處理「斷線期間先開倉後平倉」的順序重放問題，這是最容易出 Bug 的環節。
2.  **系統不確定性**: 為了捕捉極少數「剛好沒過期且價格未跑遠」的漏網之魚，而引入複雜的歷史回放代碼，性價比低。

---

## 3. 優化建議 (Recommendation)

建議將策略調整為 **「重連不回補，直接對帳」**：

1.  **移除歷史開倉回補**: 斷線重連後，直接捨棄所有積壓的「開倉」訊號。
2.  **強化對帳 (Reconciliation)**:
    *   重連時，立即執行一次狀態比對。
    *   檢查：`我的倉位` vs `訊號源當前倉位`。
    *   若訊號源已平倉而我仍持有，則觸發平倉；若訊號源持有但我空手，則可選擇忽略（避免半途進場）或僅在價格有利時跟進。

**結論**: 這樣的設計能大幅降低 `Monitor` 與 `Strategy` 層的代碼複雜度，同時確保不會因為資料遺漏而持有「殭屍倉位」。

---

*本文件供後續開發階段參考，若發現原架構實作過於困難或不穩定，可依此建議進行裁切。*
